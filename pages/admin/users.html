<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Al-Baraka Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/custom.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.auth-checked {
            opacity: 1;
        }
    </style>
    <script>
        (function () {
            const user = localStorage.getItem('restaurant_current_user');
            if (!user) {
                window.location.href = '../../index.html';
                return;
            }
            const userData = JSON.parse(user);
            if (userData.role !== 'admin') {
                window.location.href = '../../index.html';
                return;
            }
        })();
    </script>
</head>

<body class="bg-slate-50 min-h-screen flex">
    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside
        class="admin-sidebar w-64 bg-white border-r border-slate-200 lg:flex flex-col fixed h-full transition-all z-50">
        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-utensils"></i>
                </div>
                <span id="restaurantNameLabel" class="font-bold text-xl text-slate-800">Al-Baraka</span>
            </div>
            <button id="closeSidebar" class="lg:hidden text-slate-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="dashboard.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                <i class="fas fa-th-large"></i><span>Dashboard</span>
            </a>
            <a href="users.html"
                class="flex items-center gap-3 px-4 py-3 bg-amber-50 text-amber-600 rounded-xl font-medium">
                <i class="fas fa-users"></i><span>Users</span>
            </a>
            <a href="menu.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-utensils"></i><span>Menu</span>
            </a>
            <a href="reports.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-chart-line"></i><span>Reports</span>
            </a>
            <a href="settings.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-100">
            <button id="logoutBtn"
                class="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition-all">
                <i class="fas fa-sign-out-alt"></i><span>Logout</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 lg:ml-64 p-6 lg:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
            <div class="flex items-center gap-4">
                <button id="openSidebar"
                    class="lg:hidden w-10 h-10 bg-white border border-slate-200 rounded-xl flex items-center justify-center text-slate-600">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-800">User Management</h1>
                    <p class="text-xs md:text-sm text-slate-500">Staff members list</p>
                </div>
            </div>
            <button id="addUserBtn"
                class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-amber-200 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Add New User</span>
            </button>
        </header>

        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-slate-50/50 text-slate-400 text-xs font-bold uppercase tracking-wider">
                        <th class="px-6 py-4">Full Name</th>
                        <th class="px-6 py-4">Username</th>
                        <th class="px-6 py-4">Role</th>
                        <th class="px-6 py-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody" class="divide-y divide-slate-100 text-sm">
                    <!-- Dynamic users -->
                </tbody>
            </table>
        </div>

        <!-- Add User Modal -->
        <div id="userModal"
            class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                <h2 id="modalTitle" class="text-xl font-bold text-slate-800 mb-6">Add New User</h2>
                <form id="userForm" class="space-y-4">
                    <input type="hidden" id="editUserId">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                        <input type="text" id="fullName" required
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Role</label>
                        <select id="role" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                            <option value="admin">Admin</option>
                            <option value="reception">Reception</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                    <div class="flex gap-3 mt-8">
                        <button type="button" id="closeModal"
                            class="flex-1 px-4 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50">Cancel</button>
                        <button type="submit"
                            class="flex-1 px-4 py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 shadow-lg shadow-amber-200">Save
                            User</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from '../../js/auth.js';
        import { checkAuth } from '../../middleware/auth-guard.js';
        import { storage, keys } from '../../js/storage.js';
        import { generateId } from '../../js/utils.js';

        // Protected Page
        checkAuth('admin');

        const userTableBody = document.getElementById('userTableBody');
        const userModal = document.getElementById('userModal');
        const userForm = document.getElementById('userForm');
        const addUserBtn = document.getElementById('addUserBtn');
        const closeModal = document.getElementById('closeModal');
        const logoutBtn = document.getElementById('logoutBtn');

        const settings = storage.get(keys.SETTINGS) || { restaurantName: 'Al-Baraka Restaurant' };

        // Sidebar Toggle
        const sidebar = document.querySelector('.admin-sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const openBtn = document.getElementById('openSidebar');
        const closeBtn = document.getElementById('closeSidebar');

        const toggleSidebar = () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        };

        openBtn.addEventListener('click', toggleSidebar);
        closeBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        document.getElementById('restaurantNameLabel').textContent = settings.restaurantName;

        logoutBtn.addEventListener('click', () => auth.logout());

        const loadUsers = () => {
            const users = storage.get(keys.USERS) || [];
            userTableBody.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 transition-all">
                    <td class="px-6 py-4 font-medium text-slate-800">${u.fullName}</td>
                    <td class="px-6 py-4 text-slate-500">${u.username}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-bold uppercase">${u.role}</span>
                    </td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editUser('${u.id}')" class="text-amber-500 hover:bg-amber-50 w-8 h-8 rounded-lg flex items-center justify-center transition-all"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-500 hover:bg-red-50 w-8 h-8 rounded-lg flex items-center justify-center transition-all"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.editUser = (id) => {
            const users = storage.get(keys.USERS);
            const user = users.find(u => u.id === id);
            document.getElementById('editUserId').value = user.id;
            document.getElementById('fullName').value = user.fullName;
            document.getElementById('username').value = user.username;
            document.getElementById('password').value = user.password;
            document.getElementById('role').value = user.role;
            document.getElementById('modalTitle').textContent = 'Edit User';
            userModal.classList.remove('hidden');
        };

        window.deleteUser = (id) => {
            if (confirm('Are you sure you want to delete this user?')) {
                let users = storage.get(keys.USERS);
                users = users.filter(u => u.id !== id);
                storage.set(keys.USERS, users);
                loadUsers();
            }
        };

        addUserBtn.addEventListener('click', () => {
            userForm.reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('modalTitle').textContent = 'Add New User';
            userModal.classList.remove('hidden');
        });

        closeModal.addEventListener('click', () => userModal.classList.add('hidden'));

        userForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const userData = {
                id: id || generateId(),
                fullName: e.target.fullName.value,
                username: e.target.username.value,
                password: e.target.password.value,
                role: e.target.role.value
            };

            let users = storage.get(keys.USERS) || [];
            if (id) {
                users = users.map(u => u.id === id ? userData : u);
            } else {
                users.push(userData);
            }

            storage.set(keys.USERS, users);
            userModal.classList.add('hidden');
            loadUsers();
        });

        loadUsers();
        document.body.classList.add('auth-checked');
    </script>
</body>

</html>