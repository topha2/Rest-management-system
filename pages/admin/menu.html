<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Menu - Al-Baraka Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/custom.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.auth-checked {
            opacity: 1;
        }
    </style>
    <script type="module" src="../../js/authGuard.js"></script>
</head>

<body class="bg-slate-50 min-h-screen flex">
    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="admin-sidebar w-64 bg-white border-r border-slate-200 lg:flex flex-col fixed h-full transition-all">
        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-utensils"></i>
                </div>
                <span id="restaurantNameLabel" class="font-bold text-xl text-slate-800">Al-Baraka</span>
            </div>
            <button id="closeSidebar" class="lg:hidden text-slate-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="dashboard.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-th-large"></i><span>Dashboard</span>
            </a>
            <a href="users.html" class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-users"></i><span>Users</span>
            </a>
            <a href="menu.html"
                class="flex items-center gap-3 px-4 py-3 bg-amber-50 text-amber-600 rounded-xl font-medium">
                <i class="fas fa-utensils"></i><span>Menu</span>
            </a>
            <a href="reports.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-chart-line"></i><span>Reports</span>
            </a>
            <a href="settings.html"
                class="flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-100">
            <button id="logoutBtn"
                class="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition-all">
                <i class="fas fa-sign-out-alt"></i><span>Logout</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 lg:ml-64 p-6 lg:p-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
            <div class="flex items-center gap-4">
                <button id="openSidebar"
                    class="lg:hidden w-10 h-10 bg-white border border-slate-200 rounded-xl flex items-center justify-center text-slate-600">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-800">Menu Management</h1>
                    <p class="text-xs md:text-sm text-slate-500">Delicious food and drinks</p>
                </div>
            </div>
            <button id="addItemBtn"
                class="bg-amber-500 hover:bg-amber-600 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-amber-200 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>Add Item</span>
            </button>
        </header>

        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-slate-50/50 text-slate-400 text-xs font-bold uppercase tracking-wider">
                        <th class="px-6 py-4">Image</th>
                        <th class="px-6 py-4">Item Name</th>
                        <th class="px-6 py-4">Category</th>
                        <th class="px-6 py-4">Price</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="menuTableBody" class="divide-y divide-slate-100 text-sm">
                    <!-- Dynamic menu items -->
                </tbody>
            </table>
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="itemModal"
            class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-3xl p-8 max-w-xl w-full shadow-2xl">
                <h2 id="modalTitle" class="text-xl font-bold text-slate-800 mb-6">Add New Menu Item</h2>
                <form id="itemForm" class="grid grid-cols-2 gap-4">
                    <input type="hidden" id="editItemId">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Item Name</label>
                        <input type="text" id="itemName" required
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                        <select id="itemCategory"
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                            <option value="rice">Rice</option>
                            <option value="meat">Meat</option>
                            <option value="chicken">Chicken</option>
                            <option value="drinks">Drinks</option>
                            <option value="coffee">Coffee</option>
                            <option value="desserts">Desserts</option>
                        </select>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Price</label>
                        <input type="number" step="0.01" id="itemPrice" required
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                        <select id="itemStatus"
                            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                            <option value="available">Available</option>
                            <option value="unavailable">Unavailable</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Item Image</label>
                        <div class="flex items-center gap-4">
                            <div id="imagePreview"
                                class="w-20 h-20 rounded-2xl bg-slate-100 flex items-center justify-center border-2 border-dashed border-slate-200 overflow-hidden">
                                <i class="fas fa-image text-slate-300 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <label for="itemImageFile"
                                    class="inline-flex items-center px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-medium cursor-pointer hover:bg-slate-200 transition-all border border-slate-200">
                                    <i class="fas fa-upload mr-2"></i>
                                    <span>Import from Device</span>
                                </label>
                                <input type="file" id="itemImageFile" accept="image/*" class="hidden">
                                <input type="hidden" id="itemImageBase64">
                                <p class="text-xs text-slate-400 mt-2">Recommended: Square image, max 1MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 flex gap-3 mt-6">
                        <button type="button" id="closeModal"
                            class="flex-1 px-4 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 transition-all">Cancel</button>
                        <button type="submit"
                            class="flex-1 px-4 py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 shadow-lg shadow-amber-200 transition-all">Save
                            Item</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from '../../js/auth.js';
        import { checkAuth } from '../../middleware/auth-guard.js';
        import { storage, keys } from '../../js/storage.js';
        import { generateId, formatCurrency } from '../../js/utils.js';

        // Protected Page
        checkAuth('admin');

        const menuTableBody = document.getElementById('menuTableBody');
        const itemModal = document.getElementById('itemModal');
        const itemForm = document.getElementById('itemForm');
        const addItemBtn = document.getElementById('addItemBtn');
        const closeModal = document.getElementById('closeModal');
        const logoutBtn = document.getElementById('logoutBtn');

        const settings = storage.get(keys.SETTINGS) || { restaurantName: 'Al-Baraka Restaurant' };

        // Sidebar Toggle
        const sidebar = document.querySelector('.admin-sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const openBtn = document.getElementById('openSidebar');
        const closeBtn = document.getElementById('closeSidebar');

        const toggleSidebar = () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        };

        openBtn.addEventListener('click', toggleSidebar);
        closeBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        document.getElementById('restaurantNameLabel').textContent = settings.restaurantName;

        logoutBtn.addEventListener('click', () => auth.logout());

        const itemImageFile = document.getElementById('itemImageFile');
        const itemImageBase64 = document.getElementById('itemImageBase64');
        const imagePreview = document.getElementById('imagePreview');

        itemImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result;
                    itemImageBase64.value = base64String;
                    imagePreview.innerHTML = `<img src="${base64String}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        });

        const loadMenu = async () => {
            const menu = await storage.get(keys.MENU) || [];
            menuTableBody.innerHTML = menu.map(item => `
                <tr class="hover:bg-slate-50 transition-all">
                    <td class="px-6 py-4">
                        <div class="w-12 h-12 rounded-xl bg-slate-100 overflow-hidden border border-slate-200">
                            <img src="${item.image || '../../assets/images/food/placeholder.jpg'}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/80?text=Food'">
                        </div>
                    </td>
                    <td class="px-6 py-4 font-medium text-slate-800">
                        <div>${item.name}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold uppercase">${item.category}</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">${formatCurrency(item.price)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 ${item.status === 'available' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} rounded-lg text-xs font-bold">
                            ${item.status === 'available' ? 'Available' : 'Sold Out'}
                        </span>
                    </td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editItem('${item.id}')" class="text-amber-500 hover:bg-amber-50 w-8 h-8 rounded-lg flex items-center justify-center transition-all"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteItem('${item.id}')" class="text-red-500 hover:bg-red-50 w-8 h-8 rounded-lg flex items-center justify-center transition-all"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.editItem = (id) => {
            const menu = storage.get(keys.MENU);
            const item = menu.find(i => i.id === id);
            document.getElementById('editItemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemStatus').value = item.status;
            document.getElementById('itemImageBase64').value = item.image;

            if (item.image) {
                imagePreview.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover">`;
            } else {
                imagePreview.innerHTML = `<i class="fas fa-image text-slate-300 text-xl"></i>`;
            }

            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            itemModal.classList.remove('hidden');
        };

        window.deleteItem = (id) => {
            if (confirm('Delete this item from menu?')) {
                let menu = storage.get(keys.MENU);
                menu = menu.filter(i => i.id !== id);
                storage.set(keys.MENU, menu);
                loadMenu();
            }
        };

        addItemBtn.addEventListener('click', () => {
            itemForm.reset();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemImageBase64').value = '';
            imagePreview.innerHTML = `<i class="fas fa-image text-slate-300 text-xl"></i>`;
            document.getElementById('modalTitle').textContent = 'Add New Menu Item';
            itemModal.classList.remove('hidden');
        });

        closeModal.addEventListener('click', () => itemModal.classList.add('hidden'));

        itemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            const itemData = {
                id: id || generateId(),
                name: e.target.itemName.value,
                category: e.target.itemCategory.value,
                price: parseFloat(e.target.itemPrice.value),
                status: e.target.itemStatus.value,
                image: document.getElementById('itemImageBase64').value || ''
            };

            let menu = storage.get(keys.MENU) || [];
            if (id) {
                menu = menu.map(i => i.id === id ? itemData : i);
            } else {
                menu.push(itemData);
            }

            storage.set(keys.MENU, menu);
            itemModal.classList.add('hidden');
            loadMenu();
        });

        loadMenu();
        document.body.classList.add('auth-checked');
    </script>
</body>

</html>